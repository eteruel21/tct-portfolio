<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Agregar al calendario</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;text-align:center;padding:40px;color:#0D3B66}
    .btn{display:inline-block;margin:8px;padding:12px 20px;border-radius:10px;text-decoration:none;font-weight:700}
    .gcal{background:#0D3B66;color:#fff}
    .ics{background:#FFD700;color:#0D3B66}
  </style>
</head>
<body>
  <h2>Redirigiendo a tu calendario…</h2>
  <p>Si no ocurre nada, usa los botones:</p>
  <p>
    <a id="btn-ics" class="btn ics" href="#" rel="noopener noreferrer">iPhone / Outlook (.ics)</a>
    <a id="btn-gcal" class="btn gcal" href="#" rel="noopener noreferrer" target="_blank">Google Calendar</a>
  </p>

  <script>
    (function(){
      const q = new URLSearchParams(location.search);
      const rawG = q.get("g");
      const rawI = q.get("i");
      const g = rawG ? decodeURIComponent(rawG) : null;
      const i = rawI ? decodeURIComponent(rawI) : null;

      const btnIcs = document.getElementById("btn-ics");
      const btnGcal = document.getElementById("btn-gcal");
      btnIcs.href = i || "#";
      btnGcal.href = g || "#";

      const ua = navigator.userAgent || navigator.vendor || "";
      const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === "MacIntel" && navigator.maxTouchPoints > 1);
      const isAndroid = /Android/i.test(ua);

      function forceDownload(dataUrl, filename = "evento.ics") {
        try {
          const a = document.createElement("a");
          a.href = dataUrl;
          a.download = filename;
          a.style.display = "none";
          document.body.appendChild(a);
          a.click();
          setTimeout(() => { document.body.removeChild(a); }, 1000);
        } catch (e) { console.error("download failed", e); }
      }

      try {
        // iOS: intentar abrir data: (esto suele abrir la app de Calendario)
        if (isIOS && i) { location.replace(i); return; }
        // Android: abrir Google Calendar si está disponible
        if (isAndroid && g) { location.replace(g); return; }
        // Desktop / general: priorizar Google Calendar; si no, forzar descarga .ics
        if (g) {
          // abrir en nueva pestaña para no bloquear la página
          window.open(g, "_blank", "noopener");
          // además intentar abrir .ics si existe para clientes de escritorio
          if (i) forceDownload(i, "evento.ics");
          return;
        } else if (i) {
          // si i es data: intenta descarga directa
          if (i.startsWith("data:")) {
            forceDownload(i, "evento.ics");
            // algunos navegadores aceptan location.href a data: para forzar apertura
            try { location.replace(i); } catch(e) {}
          } else {
            // si es URL normal, navegar a ella
            location.replace(i);
          }
          return;
        }
      } catch (e) {
        console.error(e);
      }
    })();
  </script>
</body>
</html>
